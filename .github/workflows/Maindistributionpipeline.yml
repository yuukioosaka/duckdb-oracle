# ─────────────────────────────────────────────────────────────────────────────
# DuckDB Oracle Extension — Main Distribution Pipeline
#
# DuckDB の extension-ci-tools の再利用可能ワークフローを呼び出し、
# 全プラットフォーム向けのビルド・テスト・配布を行う。
#
# 参考: https://github.com/duckdb/extension-ci-tools
# ─────────────────────────────────────────────────────────────────────────────
name: Main Extension Distribution Pipeline

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      override_duckdb_version:
        description: 'Override DuckDB version (e.g. v1.2.0)'
        required: false
        default: ''

# 同一 ref への重複実行をキャンセル
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' || github.sha }}
  cancel-in-progress: true

env:
  # ── ターゲット DuckDB バージョン ──────────────────────────────────────────
  # extension-ci-tools のブランチ名と同期させること
  DUCKDB_VERSION: v1.2.0
  # ── 拡張設定 ──────────────────────────────────────────────────────────────
  EXTENSION_NAME: oracle_scanner
  # ── S3 配布先（オプション） ───────────────────────────────────────────────
  # S3_BUCKET を設定しない場合は GitHub Artifacts のみに保存される
  # S3_BUCKET: ${{ vars.S3_BUCKET }}

jobs:
  # ── Linux x86_64 ──────────────────────────────────────────────────────────
  linux-amd64:
    name: Linux x86_64
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.2.0
    with:
      duckdb_version: ${{ inputs.override_duckdb_version || 'v1.2.0' }}
      extension_name: oracle_scanner
      build_arch: linux_amd64
      # Oracle Instant Client セットアップを事前フックとして実行
      extra_toolchain_flags: ''
    secrets:
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_DEPLOY_ID: ${{ secrets.S3_DEPLOY_ID }}
      S3_DEPLOY_KEY: ${{ secrets.S3_DEPLOY_KEY }}
      DUCKDB_EXTENSION_SIGNING_PK: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}

  # ── Linux x86_64 (musl / Alpine) ──────────────────────────────────────────
  linux-amd64-musl:
    name: Linux x86_64 (musl)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.2.0
    with:
      duckdb_version: ${{ inputs.override_duckdb_version || 'v1.2.0' }}
      extension_name: oracle_scanner
      build_arch: linux_amd64_musl
    secrets:
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_DEPLOY_ID: ${{ secrets.S3_DEPLOY_ID }}
      S3_DEPLOY_KEY: ${{ secrets.S3_DEPLOY_KEY }}
      DUCKDB_EXTENSION_SIGNING_PK: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}

  # ── Linux ARM64 ───────────────────────────────────────────────────────────
  linux-arm64:
    name: Linux ARM64
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.2.0
    with:
      duckdb_version: ${{ inputs.override_duckdb_version || 'v1.2.0' }}
      extension_name: oracle_scanner
      build_arch: linux_arm64
    secrets:
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_DEPLOY_ID: ${{ secrets.S3_DEPLOY_ID }}
      S3_DEPLOY_KEY: ${{ secrets.S3_DEPLOY_KEY }}
      DUCKDB_EXTENSION_SIGNING_PK: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}

  # ── macOS x86_64 ──────────────────────────────────────────────────────────
  macos-amd64:
    name: macOS x86_64
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.2.0
    with:
      duckdb_version: ${{ inputs.override_duckdb_version || 'v1.2.0' }}
      extension_name: oracle_scanner
      build_arch: osx_amd64
    secrets:
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_DEPLOY_ID: ${{ secrets.S3_DEPLOY_ID }}
      S3_DEPLOY_KEY: ${{ secrets.S3_DEPLOY_KEY }}
      DUCKDB_EXTENSION_SIGNING_PK: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}

  # ── macOS ARM64 (Apple Silicon) ───────────────────────────────────────────
  macos-arm64:
    name: macOS ARM64 (Apple Silicon)
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.2.0
    with:
      duckdb_version: ${{ inputs.override_duckdb_version || 'v1.2.0' }}
      extension_name: oracle_scanner
      build_arch: osx_arm64
    secrets:
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_DEPLOY_ID: ${{ secrets.S3_DEPLOY_ID }}
      S3_DEPLOY_KEY: ${{ secrets.S3_DEPLOY_KEY }}
      DUCKDB_EXTENSION_SIGNING_PK: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}

  # ── Windows x86_64 ────────────────────────────────────────────────────────
  windows-amd64:
    name: Windows x86_64
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.2.0
    with:
      duckdb_version: ${{ inputs.override_duckdb_version || 'v1.2.0' }}
      extension_name: oracle_scanner
      build_arch: windows_amd64
    secrets:
      S3_REGION: ${{ secrets.S3_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_DEPLOY_ID: ${{ secrets.S3_DEPLOY_ID }}
      S3_DEPLOY_KEY: ${{ secrets.S3_DEPLOY_KEY }}
      DUCKDB_EXTENSION_SIGNING_PK: ${{ secrets.DUCKDB_EXTENSION_SIGNING_PK }}

  # ── GitHub Release の作成（タグ push 時のみ） ─────────────────────────────
  create-release:
    name: Create GitHub Release
    needs:
      - linux-amd64
      - linux-amd64-musl
      - linux-arm64
      - macos-amd64
      - macos-arm64
      - windows-amd64
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display artifact structure
        run: find artifacts/ -type f | sort

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "oracle_scanner ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          files: |
            artifacts/**/*.duckdb_extension
            artifacts/**/*.duckdb_extension.gz
          body: |
            ## DuckDB Oracle Extension ${{ github.ref_name }}

            ### インストール方法
            ```sql
            INSTALL oracle_scanner FROM 'https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}';
            LOAD oracle_scanner;
            ```

            ### 使い方
            ```sql
            ATTACH 'host=myhost port=1521 service=ORCL user=scott password=tiger'
              AS oracle_db (TYPE oracle);
            SELECT * FROM oracle_db.HR.EMPLOYEES LIMIT 10;
            ```

            ### 動作確認済み DuckDB バージョン
            - DuckDB ${{ env.DUCKDB_VERSION }}

            ### 変更点
            詳細は [CHANGELOG.md](CHANGELOG.md) を参照してください。